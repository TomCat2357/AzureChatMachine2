version: '3.2'
services:
  streamlit:
    container_name: 'streamlit'
    build: 
      context: ./docker/streamlit_docker/.
      dockerfile: Dockerfile
    
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}  # コンテナ実行時に使用
      - LATE_LIMIT=${LATE_LIMIT}
      - AVAILABLE_MODELS=${AVAILABLE_MODELS}
      - 'TZ=Asia/Tokyo'
    ports : 
      - "8501:8501"
    
    expose:
      - "8501"
    #command: sh -c "tail -f /dev/null"
    command: sh -c "streamlit run chat_openai0_28.py"
    depends_on:
      - apache
      - redis_6379
    volumes:
      - ./log:/root/log/
      - ./data/streamlit_data:/root/data/ 
      - ./docker/streamlit_docker:/root/docker/
    restart: always
    working_dir: '/root/docker/'
  
  apache:
    container_name: 'apache'
    build: 
      context: ./docker/apache_docker/.
      dockerfile: Dockerfile
      args:
        DOMAIN_NAME: ${DOMAIN_NAME}
    env_file:
      - .env
    expose :
      - "443"
      - "80"
    ports : 
      - "443:443"
      - "80:80"
    volumes:
      - ./data/apache_data:/root/data/ 
      - ./host/log/directory:/var/log/apache2
      #- ./docker/apache_docker:/root/docker/
      #- ./docker/apache_docker/keys:/etc/ssl/origin_keys
    restart: always

  redis_6379:
    container_name: 'redis_6379'
    image: redis:latest
    ports:
      - "6379:6379"
    expose:
      - "6379"
    volumes:
      - ./data/redis_6379_snapshot/:/data/ # wsl2用
      - ./docker/redis_conf/6379/:/usr/local/etc/redis/
    command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
    restart: always

